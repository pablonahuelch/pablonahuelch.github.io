<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Servicios Santa Maria • Presupuesto</title>

  <style>
    :root{
      --brand:#1f66b3;
      --brand2:#134a86;
      --bg:#f2f6fb;
      --card:#ffffff;
      --ink:#152233;
      --muted:#6b7483;
      --line:#0f0f10;          /* borde negro “excel” */
      --soft:#dfe6ef;          /* UI */
      --shadow:0 16px 50px rgba(8,20,40,.12);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    /* ===== Barra superior (UI) ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,#0b213a,#0f2a4b);
      color:#fff;
      box-shadow:0 8px 20px rgba(0,0,0,.15);
    }
    .topbar .inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      min-width:0;
    }
    .brand img{
      width:34px;height:34px; border-radius:10px;
      object-fit:cover; background:#fff;
      flex:0 0 auto;
    }
    .brand .txt{
      min-width:0;
    }
    .brand small{
      display:block;
      font-weight:500;
      opacity:.85;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:0;
      padding:12px 16px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.15);
      user-select:none;
    }
    .btn.secondary{background:#ffffff; color:#0b213a}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
    .btn.danger{background:#c01616; color:#fff}
    .btn:active{transform:translateY(1px)}

    /* ===== Controles (UI) ===== */
    .controls{
      max-width:1200px;
      margin:18px auto 0;
      padding:0 16px;
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      background:#fff;
      border:1px solid rgba(15,33,55,.08);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:0 10px 26px rgba(8,20,40,.10);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
    }
    .pill input[type="checkbox"]{
      width:20px;height:20px;
      accent-color:var(--brand);
      cursor:pointer;
    }

    /* ===== Hoja A4 (screen) ===== */
    .pageWrap{
      max-width:1200px;
      margin:16px auto 40px;
      padding:0 16px;
      display:flex;
      justify-content:center;
    }

    .sheet{
      width:210mm;                 /* A4 real */
      min-height:297mm;
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:10px;
      padding:14mm 14mm 14mm;
      position:relative;
      transform-origin: top center; /* para el “fit” en celular */
    }

    /* “Tabla” estilo Excel */
    .box{
      border:2px solid var(--line);
      width:100%;
    }
    .hline{ border-top:2px solid var(--line); }
    .vline{ border-left:2px solid var(--line); }

    /* Encabezado */
    .headRow{
      display:grid;
      grid-template-columns: 2fr 1fr;
      min-height:105px;
    }
    .leftHead{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 12px;
    }
    .logo{
      width:92px; height:92px;
      object-fit:contain;
      flex:0 0 auto;
    }
    .servicesText{
      flex:1;
      text-align:center;
      font-weight:800;
      font-size:11.5px;
      line-height:1.25;
      letter-spacing:.15px;
      text-transform:uppercase;
      padding:0 4px;
    }
    .rightHead{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      text-align:left;
      font-weight:800;
      font-size:12.5px;
      line-height:1.55;
      white-space:nowrap;
    }
    .metaLine{ display:block; }

    /* Lineas bajo encabezado */
    .addrLine{
      font-weight:800;
      text-align:center;
      font-size:12.5px;
      padding:8px 10px;
    }
    .ivaLine{
      font-weight:800;
      font-size:12.5px;
      padding:8px 10px;
    }
    .title{
      text-align:center;
      font-weight:900;
      letter-spacing:.8px;
      padding:10px 10px;
    }

    /* Cliente */
    .client{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:10px;
      padding:10px 10px;
      font-size:12.5px;
      align-items:center;
    }
    .client label{ font-weight:800; }
    .lineInput{
      border:0;
      border-bottom:1px solid rgba(0,0,0,.55);
      outline:none;
      padding:6px 6px;
      font-size:12.5px;
      background:transparent;
      width:100%;
    }
    /* placeholder en pantalla, invisible al imprimir */
    .lineInput::placeholder{ color:rgba(21,34,51,.45); }

    /* Detalle + Precio */
    .detailHeader{
      display:grid;
      grid-template-columns: 1fr 180px;
      border-top:2px solid var(--line);
      border-bottom:2px solid var(--line);
      font-weight:900;
      text-align:center;
      font-size:12px;
      padding:0;
    }
    .detailHeader > div{ padding:8px 10px; }
    .detailHeader > div:last-child{ border-left:2px solid var(--line); }

    .items{
      display:grid;
      grid-template-columns: 1fr 180px;
      min-height:360px;
    }
    .items .left{ padding:10px 10px 12px; }
    .items .right{
      padding:10px 10px 12px;
      border-left:2px solid var(--line);
    }

    .itemRow{
      display:grid;
      grid-template-columns: 34px 1fr;
      gap:8px;
      align-items:end;
      margin:8px 0;
      font-size:12.5px;
    }
    .n{ font-weight:900; text-align:right; padding-right:6px; }
    .itemText{
      border:0;
      border-bottom:1px dotted rgba(0,0,0,.6);
      outline:none;
      padding:6px 4px;
      font-size:12.5px;
      background:transparent;
      width:100%;
    }

    .priceRow{
      display:grid;
      grid-template-columns: 16px 1fr;
      gap:8px;
      align-items:end;
      margin:8px 0;
      font-size:12.5px;
    }
    .peso{ font-weight:900; text-align:center; }
    .itemPrice{
      border:0;
      border-bottom:1px dotted rgba(0,0,0,.6);
      outline:none;
      padding:6px 4px;
      font-size:12.5px;
      text-align:right;
      background:transparent;
      width:100%;
    }

    /* ===== Pie (alineación mejor: texto a la izq + firma a la derecha, todo centrado verticalmente) ===== */
    .footer{
      border-top:2px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 180px;
      page-break-inside: avoid;
      break-inside: avoid;
      min-height:120px;
    }

    .footer .leftFoot{
      padding:8px 10px;
      display:grid;
      grid-template-columns: 1fr 240px; /* texto + firma */
      gap:10px;
      align-items:center;              /* centra verticalmente ambas columnas */
    }

    .leftText{
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:center;
      min-height:100%;
    }

    .footLine{
      font-size:11.5px;
      font-weight:800;
      line-height:1.25;
    }

    .signWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .signWrap img{
      width:200px;
      height:auto;
      object-fit:contain;
      display:block;
      max-width:100%;
    }
    .signName{
      text-align:center;
      font-weight:900;
      font-size:11px;
      line-height:1.2;
    }

    .footer .rightFoot{
      border-left:2px solid var(--line);
      padding:8px 10px;
      display:flex;
      align-items:center;     /* centro vertical */
      justify-content:center; /* centro horizontal */
    }

    /* TOTAL: centrado, sin línea, y un solo $ */
    .totalBox{
      border-top:0;
      padding-top:0;
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap:10px;
      font-weight:900;
      width:100%;
    }
    .totalBox .lbl{font-size:14px}
    .totalBox .amt{font-size:16px}

    /* ===== Responsive UI (celular) ===== */
    @media (max-width: 820px){
      .topbar .inner{
        padding:12px 12px;
        align-items:flex-start;
        flex-direction:column;
        gap:10px;
      }
      .brand small{max-width:100%;}
      .actions{width:100%; justify-content:space-between;}
      .controls{padding:0 12px;}
      .pageWrap{padding:0 8px;}
    }

    /* ===== Impresión ===== */
    @media print{
      body{background:#fff}
      .topbar, .controls{display:none !important}
      .pageWrap{margin:0; padding:0}
      .sheet{
        box-shadow:none;
        border-radius:0;
        width:auto;
        min-height:auto;
        padding:0;
        transform:none !important; /* muy importante: no escalar en impresión */
      }
      /* placeholders invisibles al imprimir (así queda “blanco” si no cargan nada) */
      input::placeholder{ color:transparent !important; }
      /* opcional */
      @page{ size:A4; margin:10mm; }
    }
  </style>
</head>

<body>
  <!-- Barra superior -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <img src="Logo.png" alt="Logo">
        <div class="txt">
          Servicios Santa Maria • Presupuesto
          <small>Tip: “Descargar PDF” → listo para compartir por WhatsApp.</small>
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" type="button" onclick="history.back()">Volver</button>
        <button class="btn primary" type="button" onclick="downloadPDF()">Descargar PDF</button>
        <button class="btn danger" type="button" onclick="salir()">Salir</button>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="controls">
    <button class="btn primary" type="button" onclick="addItem()">+ Agregar item</button>
    <button class="btn secondary" type="button" onclick="removeLast()">− Quitar último</button>

    <div class="pill" title="Marca si el monto incluye IVA">
      <span>Contiene IVA</span>
      <input id="chkIva" type="checkbox" onchange="renderFooterText()">
    </div>
  </div>

  <!-- Hoja -->
  <div class="pageWrap">
    <div class="sheet" id="sheet">
      <div class="box" id="printArea">
        <!-- Encabezado -->
        <div class="headRow">
          <div class="leftHead">
            <img class="logo" src="Logo.png" alt="Logo">
            <div class="servicesText" id="servicesText">
              PERFORACIONES - FILMACIONES - SISTEMA DE RIEGO ESTUDIO DE SUELO ASESORAMIENTO DE SISTEMA PRODUCTIVOS
              REFRIGERACION INDUSTRIAL, COMERCIAL, FAMILIAR TENDIDO DE MEDIA TENSION-MANTENIMIENTO DE TABLERO
            </div>
          </div>

          <div class="rightHead vline">
            <div>
              <span class="metaLine" id="fechaLine">FECHA : --/--/----</span>
              <span class="metaLine">C.U.I.T.: 20-16503745-7</span>
              <span class="metaLine">INGRESOS BRUTOS: 20-16503745-7</span>
              <span class="metaLine">INICIO DE ACTIVIDADES: 01/07/2018</span>
            </div>
          </div>
        </div>

        <div class="hline addrLine">B° Jardín C28 - Cel (3838) 497748 - SANTA MARIA CATAMARCA</div>
        <div class="hline ivaLine">I.V.A. RESPONSABLE INSCRIPTO</div>
        <div class="hline title">PROFORMA</div>

        <!-- Cliente -->
        <div class="hline client">
          <label>Señor(es):</label>
          <input class="lineInput" id="inpSenores" placeholder="">
        </div>
        <div class="client" style="border-top:0">
          <label>Domicilio:</label>
          <input class="lineInput" id="inpDomicilio" placeholder="">
        </div>

        <!-- Detalle -->
        <div class="detailHeader">
          <div>DETALLE</div>
          <div>Precio TOTAL</div>
        </div>

        <div class="items">
          <div class="left" id="itemsLeft"></div>
          <div class="right" id="itemsRight"></div>
        </div>

        <!-- Pie -->
        <div class="footer">
          <div class="leftFoot">
            <div class="leftText">
              <div class="footLine" id="lineMonto">Son pesos: —</div>
              <div class="footLine" id="lineIva">El monto NO contiene IVA</div>
              <div class="footLine">La validez de la oferta es de 10 días</div>
            </div>

            <div class="signWrap">
              <img src="firma.png" alt="Firma">
              <div class="signName">
                CHAILE TRANSITO ROQUE<br>
                Matricula Profesional 1757
              </div>
            </div>
          </div>

          <div class="rightFoot">
            <div class="totalBox">
              <span class="lbl">$</span>
              <span class="amt" id="grandTotal">0,00</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- html2pdf (para descargar PDF directo) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    // ===== Helpers =====
    const fmtARS = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function parseMoney(val){
      if(val == null) return 0;
      const s = String(val).trim();
      if(!s) return 0;
      let t = s.replace(/\s/g,'');
      if (t.includes(',')) t = t.replace(/\./g,'').replace(',', '.');
      const n = Number(t);
      return Number.isFinite(n) ? n : 0;
    }

    function setToday(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      document.getElementById('fechaLine').textContent = `FECHA : ${dd}/${mm}/${yyyy}`;
    }

    // ===== Fit A4 a pantalla (celular) sin romper impresión =====
    function fitSheetToViewport(){
      const sheet = document.getElementById('sheet');
      if(!sheet) return;

      // reset primero
      sheet.style.transform = '';
      sheet.style.marginBottom = '';

      const vw = window.innerWidth || document.documentElement.clientWidth;
      if(vw <= 820){
        // ancho disponible real (restamos padding de pageWrap)
        const available = vw - 16; // pageWrap padding aprox
        const sheetPx = sheet.getBoundingClientRect().width; // ya sin transform
        const scale = Math.min(1, available / sheetPx);

        sheet.style.transform = `scale(${scale})`;
        sheet.style.transformOrigin = 'top center';

        // Reservar alto “real” escalado para que no se superponga
        const h = sheet.scrollHeight * scale;
        sheet.style.marginBottom = `${Math.max(0, (h - sheet.scrollHeight))}px`;
      }
    }

    window.addEventListener('resize', () => {
      // pequeño debounce
      clearTimeout(window.__fitT);
      window.__fitT = setTimeout(fitSheetToViewport, 80);
    });

    // ===== Items =====
    let items = []; // { text:'', price:0 }

    function renderItems(){
      const left = document.getElementById('itemsLeft');
      const right = document.getElementById('itemsRight');
      left.innerHTML = '';
      right.innerHTML = '';

      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'itemRow';
        row.innerHTML = `
          <div class="n">${idx+1}-</div>
          <input class="itemText" value="${escapeHtml(it.text || '')}" placeholder="Detalle del item..." data-idx="${idx}">
        `;
        left.appendChild(row);

        const prow = document.createElement('div');
        prow.className = 'priceRow';
        prow.innerHTML = `
          <div class="peso">$</div>
          <input class="itemPrice" value="${it.price ? fmtARS.format(it.price) : ''}" placeholder="0,00" data-idx="${idx}">
        `;
        right.appendChild(prow);
      });

      left.querySelectorAll('.itemText').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const i = Number(e.target.dataset.idx);
          items[i].text = e.target.value;
        });
      });

      right.querySelectorAll('.itemPrice').forEach(inp=>{
        inp.addEventListener('blur', (e)=>{
          const i = Number(e.target.dataset.idx);
          const n = parseMoney(e.target.value);
          items[i].price = n;
          e.target.value = n ? fmtARS.format(n) : '';
          recalc();
        });
      });

      recalc();
      fitSheetToViewport();
    }

    function addItem(){
      items.push({ text:'', price:0 });
      renderItems();
      const last = document.querySelector('#itemsLeft .itemRow:last-child .itemText');
      if(last) last.focus();
    }

    function removeLast(){
      if(items.length <= 1) return; // mínimo 1 línea
      items.pop();
      renderItems();
    }

    // ===== Total + pie =====
    function recalc(){
      const total = items.reduce((acc, it)=> acc + (Number(it.price)||0), 0);
      // SOLO número (sin $) para evitar doble signo
      document.getElementById('grandTotal').textContent = fmtARS.format(total);
      renderFooterText(total);
    }

    function renderFooterText(totalOverride){
      const total = (typeof totalOverride === 'number') ? totalOverride
        : items.reduce((acc, it)=> acc + (Number(it.price)||0), 0);

      const cents = Math.round((total - Math.floor(total)) * 100);
      const entero = Math.floor(total);

      const letras = numeroALetras(entero);
      const cc = String(cents).padStart(2,'0');

      document.getElementById('lineMonto').textContent =
        `Son pesos: ${capitalize(letras)} con ${cc}/100`;

      const iva = document.getElementById('chkIva').checked;
      document.getElementById('lineIva').textContent =
        iva ? 'El monto SI contiene IVA' : 'El monto NO contiene IVA';
    }

    function capitalize(s){
      s = (s||'').trim();
      if(!s) return s;
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function numeroALetras(n){
      if(n === 0) return 'cero';

      const unidades = ['', 'uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'];
      const especiales = ['diez','once','doce','trece','catorce','quince','dieciséis','diecisiete','dieciocho','diecinueve'];
      const decenas = ['', '', 'veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];
      const centenas = ['', 'ciento','doscientos','trescientos','cuatrocientos','quinientos','seiscientos','setecientos','ochocientos','novecientos'];

      function menosDeCien(x){
        if(x < 10) return unidades[x];
        if(x < 20) return especiales[x-10];
        if(x < 30){
          if(x === 20) return 'veinte';
          return 'veinti' + unidades[x-20];
        }
        const d = Math.floor(x/10);
        const u = x % 10;
        return u ? `${decenas[d]} y ${unidades[u]}` : decenas[d];
      }

      function menosDeMil(x){
        if(x === 0) return '';
        if(x === 100) return 'cien';
        const c = Math.floor(x/100);
        const r = x % 100;
        const cTxt = c ? শত(centenas[c]) : '';
        const rTxt = r ? menosDeCien(r) : '';
        return [cTxt, rTxt].filter(Boolean).join(' ');
      }
      function শত(s){ return s; } // wrapper por si querés tocar luego

      let txt = '';
      let resto = n;

      if(resto >= 1000000000){
        const cnt = Math.floor(resto / 1000000000);
        resto = resto % 1000000000;
        txt += (txt ? ' ' : '') + (cnt === 1 ? 'mil millones' : `${numeroALetras(cnt)} mil millones`);
      }

      if(resto >= 1000000){
        const cnt = Math.floor(resto / 1000000);
        resto = resto % 1000000;
        txt += (txt ? ' ' : '') + (cnt === 1 ? 'un millón' : `${numeroALetras(cnt)} millones`);
      }

      if(resto >= 1000){
        const cnt = Math.floor(resto / 1000);
        resto = resto % 1000;
        txt += (txt ? ' ' : '') + (cnt === 1 ? 'mil' : `${numeroALetras(cnt)} mil`);
      }

      if(resto > 0){
        txt += (txt ? ' ' : '') + menosDeMil(resto);
      }

      txt = txt.replace(/\buno\b/g, 'un');
      return txt.trim();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // ===== Descargar PDF (A4) =====
    async function downloadPDF(){
      const area = document.getElementById('printArea');
      const sheet = document.getElementById('sheet');

      // Guardar transform actual (por el fit en celular) y quitarlo para exportar a A4 “real”
      const prevTransform = sheet.style.transform;
      const prevOrigin = sheet.style.transformOrigin;
      sheet.style.transform = 'none';
      sheet.style.transformOrigin = 'top left';

      // Nombre con fecha
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      const filename = `Presupuesto_ServiciosSantaMaria_${y}${m}${da}.pdf`;

      const opt = {
        margin:       [10, 10, 10, 10], // mm aprox en px lo maneja lib; igual respeta bastante
        filename,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      try{
        await html2pdf().set(opt).from(area).save();
      }finally{
        // restaurar fit pantalla
        sheet.style.transform = prevTransform;
        sheet.style.transformOrigin = prevOrigin || 'top center';
        fitSheetToViewport();
      }
    }

    // ===== Salir =====
    function salir(){
      window.location.href = "ingreso.html";
    }

    // ===== Init =====
    (function init(){
      setToday();
      items = [{ text:'', price:0 }]; // 1 línea inicial
      renderItems();
      renderFooterText(0);
      fitSheetToViewport();
    })();
  </script>
</body>
</html>
