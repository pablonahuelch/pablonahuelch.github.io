<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Servicios Santa Maria • Presupuesto</title>

  <style>
    :root{
      --brand:#1f66b3;
      --brand2:#134a86;
      --bg:#f2f6fb;
      --card:#ffffff;
      --ink:#152233;
      --muted:#6b7483;
      --line:#0f0f10;          /* borde negro “excel” */
      --soft:#dfe6ef;          /* UI */
      --shadow:0 16px 50px rgba(8,20,40,.12);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    /* ===== Barra superior (UI) ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,#0b213a,#0f2a4b);
      color:#fff;
      box-shadow:0 8px 20px rgba(0,0,0,.15);
    }
    .topbar .inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .brand img{
      width:34px;height:34px; border-radius:10px;
      object-fit:cover; background:#fff;
    }
    .brand small{
      display:block;
      font-weight:500;
      opacity:.85;
      margin-top:2px;
    }
    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:0;
      padding:12px 16px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.15);
    }
    .btn.secondary{background:#ffffff; color:#0b213a}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
    .btn.danger{background:#c01616; color:#fff}
    .btn:active{transform:translateY(1px)}

    /* ===== Controles (UI) ===== */
    .controls{
      max-width:1200px;
      margin:18px auto 0;
      padding:0 16px;
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      background:#fff;
      border:1px solid rgba(15,33,55,.08);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:0 10px 26px rgba(8,20,40,.10);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
    }
    .pill input[type="checkbox"]{
      width:20px;height:20px;
      accent-color:var(--brand);
      cursor:pointer;
    }

    /* ===== Hoja ===== */
    .pageWrap{
      max-width:1200px;
      margin:16px auto 40px;
      padding:0 16px;
      display:flex;
      justify-content:center;
    }

    .sheet{
      width:210mm;
      min-height:297mm;
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:10px;
      padding:14mm 14mm 14mm;
      position:relative;
    }

    /* Tabla estilo Excel */
    .box{
      border:2px solid var(--line);
      width:100%;
    }
    .hline{ border-top:2px solid var(--line); }
    .vline{ border-left:2px solid var(--line); }

    /* Encabezado */
    .headRow{
      display:grid;
      grid-template-columns: 2fr 1fr;
      min-height:105px;
    }
    .leftHead{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 12px;
    }
    .logo{
      width:92px; height:92px;
      object-fit:contain;
      flex:0 0 auto;
    }
    .servicesText{
      flex:1;
      text-align:center;
      font-weight:800;
      font-size:11.5px;
      line-height:1.25;
      letter-spacing:.15px;
      text-transform:uppercase;
      padding:0 4px;
    }
    .rightHead{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      text-align:left;
      font-weight:800;
      font-size:12.5px;
      line-height:1.55;
      white-space:nowrap;
    }
    .metaLine{ display:block; }

    .addrLine{
      font-weight:800;
      text-align:center;
      font-size:12.5px;
      padding:8px 10px;
    }
    .ivaLine{
      font-weight:800;
      font-size:12.5px;
      padding:8px 10px;
    }
    .title{
      text-align:center;
      font-weight:900;
      letter-spacing:.8px;
      padding:10px 10px;
    }

    /* Cliente */
    .client{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:10px;
      padding:10px 10px;
      font-size:12.5px;
      align-items:center;
    }
    .client label{ font-weight:800; }

    /* IMPORTANTE: sin placeholder, para que no se “imprima” gris si está vacío */
    .lineInput{
      border:0;
      border-bottom:1px solid rgba(0,0,0,.55);
      outline:none;
      padding:6px 6px;
      font-size:12.5px;
      background:transparent;
      width:100%;
      color:#000;
    }

    /* Detalle + Precio */
    .detailHeader{
      display:grid;
      grid-template-columns: 1fr 180px;
      border-top:2px solid var(--line);
      border-bottom:2px solid var(--line);
      font-weight:900;
      text-align:center;
      font-size:12px;
      padding:0;
    }
    .detailHeader > div{ padding:8px 10px; }
    .detailHeader > div:last-child{ border-left:2px solid var(--line); }

    .items{
      display:grid;
      grid-template-columns: 1fr 180px;
      min-height:360px;
      border-bottom:2px solid var(--line); /* asegura la línea completa antes del pie */
    }
    .items .left{
      padding:10px 10px 12px;
    }
    .items .right{
      padding:10px 10px 12px;
      border-left:2px solid var(--line);
    }

    .itemRow{
      display:grid;
      grid-template-columns: 34px 1fr;
      gap:8px;
      align-items:stretch;         /* clave: estira el textarea */
      margin:8px 0;
      font-size:12.5px;
    }
    .n{
      font-weight:900;
      text-align:right;
      padding-right:6px;
      display:flex;
      align-items:center;          /* número centrado vertical */
      justify-content:flex-end;
    }

    /* Textarea auto-crece */
    .itemText{
      width:100%;
      resize:none;
      overflow:hidden;
      border:0;
      border-bottom:1px dotted rgba(0,0,0,.6);
      outline:none;
      padding:6px 4px;
      font-size:12.5px;
      line-height:1.25;
      background:transparent;
      min-height:30px;
    }

    .priceRow{
      display:grid;
      grid-template-columns: 16px 1fr;
      gap:8px;
      align-items:stretch;         /* se adapta a la altura del item */
      margin:8px 0;
      font-size:12.5px;
    }
    .peso{
      font-weight:900;
      text-align:center;
      display:flex;
      align-items:center;          /* $ centrado vertical */
      justify-content:center;
    }
    .itemPrice{
      border:0;
      border-bottom:1px dotted rgba(0,0,0,.6);
      outline:none;
      padding:6px 4px;
      font-size:12.5px;
      text-align:right;
      background:transparent;
      width:100%;
      height:100%;
    }

    /* ===== Pie (líneas + firma a la derecha dentro del pie izquierdo) ===== */
    .footer{
      display:grid;
      grid-template-columns: 1fr 180px;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* Pie izquierdo ahora es grilla: texto | firma (así la firma “crece” con el texto) */
    .leftFoot{
      padding:8px 10px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:10px;
      align-items:stretch;
      min-height:120px;
    }

    .footText{
      display:flex;
      flex-direction:column;
      gap:6px;
      justify-content:flex-start;
      min-width:0;
    }

    .footLine{
      font-size:11.5px;
      font-weight:800;
      line-height:1.25;
    }

    .signWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      height:100%;
      min-width:0;
    }
    .signImg{
      flex:1;                      /* ocupa el mismo “alto disponible” que crezca con el texto */
      width:100%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      min-height:0;
      padding-bottom:2px;
    }
    .signImg img{
      width:auto;
      height:100%;
      max-height:9999px;           /* que crezca si el texto crece */
      max-width:100%;
      object-fit:contain;
      display:block;
    }
    .signName{
      text-align:center;
      font-weight:900;
      font-size:11px;
      line-height:1.2;
    }

    .rightFoot{
      border-left:2px solid var(--line);
      padding:8px 10px;
      display:flex;
      align-items:center;          /* total centrado vertical */
      justify-content:center;      /* total centrado horizontal */
    }
    .totalBox{
      display:flex;
      align-items:baseline;
      gap:10px;
      font-weight:900;
    }
    .totalBox .lbl{font-size:12px}
    .totalBox .amt{font-size:16px}

    /* ===== Responsive (solo UI, NO toca medidas de impresión) ===== */
    @media (max-width: 980px){
      .pageWrap{padding:0 10px}
      .sheet{
        width:100%;
        max-width:210mm;
        padding:10mm;
      }
      .topbar .inner{align-items:flex-start}
      .actions{gap:8px}
      .btn{padding:10px 14px}
    }

    /* ===== Impresión (A4 real + márgenes) ===== */
    @media print{
      body{background:#fff}
      .topbar, .controls{display:none !important}
      .pageWrap{margin:0; padding:0}
      .sheet{
        box-shadow:none;
        border-radius:0;
        width:auto;
        min-height:auto;
        padding:0 !important;  /* el margen lo maneja @page */
      }
      /* A4 y márgenes (esto es lo que te respeta el “aire” alrededor) */
      @page{ size:A4; margin:12mm; }
    }
  </style>
</head>

<body>
  <!-- Barra superior -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <img src="Logo.png" alt="Logo">
        <div>
          Servicios Santa Maria • Presupuesto
          <small>Tip: “Descargar PDF” → listo para compartir por WhatsApp.</small>
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" type="button" onclick="history.back()">Volver</button>
        <button class="btn primary" type="button" onclick="descargarPDF()">Descargar PDF</button>
        <button class="btn danger" type="button" onclick="salir()">Salir</button>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="controls">
    <button class="btn primary" type="button" onclick="addItem()">+ Agregar item</button>
    <button class="btn secondary" type="button" onclick="removeLast()">− Quitar último</button>

    <div class="pill" title="Marca si el monto incluye IVA">
      <span>Contiene IVA</span>
      <input id="chkIva" type="checkbox" onchange="renderFooterText()">
    </div>
  </div>

  <!-- Hoja -->
  <div class="pageWrap">
    <div class="sheet">

      <div class="box">
        <!-- Encabezado -->
        <div class="headRow">
          <div class="leftHead">
            <img class="logo" src="Logo.png" alt="Logo">
            <div class="servicesText" id="servicesText">
              PERFORACIONES - FILMACIONES - SISTEMA DE RIEGO ESTUDIO DE SUELO ASESORAMIENTO DE SISTEMA PRODUCTIVOS
              REFRIGERACION INDUSTRIAL, COMERCIAL, FAMILIAR TENDIDO DE MEDIA TENSION-MANTENIMIENTO DE TABLERO
            </div>
          </div>

          <div class="rightHead vline">
            <div>
              <span class="metaLine" id="fechaLine">FECHA : --/--/----</span>
              <span class="metaLine">C.U.I.T.: 20-16503745-7</span>
              <span class="metaLine">INGRESOS BRUTOS: 20-16503745-7</span>
              <span class="metaLine">INICIO DE ACTIVIDADES: 01/07/2018</span>
            </div>
          </div>
        </div>

        <div class="hline addrLine">B° Jardín C28 - Cel (3838) 497748 - SANTA MARIA CATAMARCA</div>
        <div class="hline ivaLine">I.V.A. RESPONSABLE INSCRIPTO</div>
        <div class="hline title">PROFORMA</div>

        <!-- Cliente (sin placeholders) -->
        <div class="hline client">
          <label>Señor(es):</label>
          <input class="lineInput" id="inpSenores" value="">
        </div>
        <div class="client" style="border-top:0">
          <label>Domicilio:</label>
          <input class="lineInput" id="inpDomicilio" value="">
        </div>

        <!-- Detalle -->
        <div class="detailHeader">
          <div>DETALLE</div>
          <div>Precio TOTAL</div>
        </div>

        <div class="items">
          <div class="left" id="itemsLeft"></div>
          <div class="right" id="itemsRight"></div>
        </div>

        <!-- Pie -->
        <div class="footer">
          <div class="leftFoot">
            <div class="footText">
              <div class="footLine" id="lineMonto">Son pesos: —</div>
              <div class="footLine" id="lineIva">El monto NO contiene IVA</div>
              <div class="footLine">La validez de la oferta es de 10 días</div>
            </div>

            <div class="signWrap">
              <div class="signImg">
                <img src="firma.png" alt="Firma">
              </div>
              <div class="signName">
                CHAILE TRANSITO ROQUE<br>
                Matricula Profesional 1757
              </div>
            </div>
          </div>

          <div class="rightFoot">
            <div class="totalBox">
              <span class="lbl">$</span>
              <span class="amt" id="grandTotal">0,00</span>
            </div>
          </div>
        </div>

      </div>
      <!-- /box -->

    </div>
  </div>

  <script>
    // ===== Helpers =====
    const fmtARS = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function parseMoney(val){
      if(val == null) return 0;
      const s = String(val).trim();
      if(!s) return 0;
      let t = s.replace(/\s/g,'');
      if (t.includes(',')) t = t.replace(/\./g,'').replace(',', '.');
      const n = Number(t);
      return Number.isFinite(n) ? n : 0;
    }

    function setToday(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      document.getElementById('fechaLine').textContent = `FECHA : ${dd}/${mm}/${yyyy}`;
    }

    // Auto-grow textarea
    function autoGrow(el){
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    // Sincroniza alturas izquierda/derecha para que el importe acompañe los renglones
    function syncRowHeights(){
      const leftRows = document.querySelectorAll('#itemsLeft .itemRow');
      const rightRows = document.querySelectorAll('#itemsRight .priceRow');
      const n = Math.min(leftRows.length, rightRows.length);

      for(let i=0;i<n;i++){
        const h = leftRows[i].offsetHeight;
        rightRows[i].style.height = h + 'px';
      }
    }

    // ===== Items =====
    let items = []; // { text:'', price:0 }

    function renderItems(){
      const left = document.getElementById('itemsLeft');
      const right = document.getElementById('itemsRight');
      left.innerHTML = '';
      right.innerHTML = '';

      items.forEach((it, idx) => {
        // Left
        const row = document.createElement('div');
        row.className = 'itemRow';
        row.innerHTML = `
          <div class="n">${idx+1}-</div>
          <textarea class="itemText" placeholder="" data-idx="${idx}">${escapeHtml(it.text || '')}</textarea>
        `;
        left.appendChild(row);

        // Right
        const prow = document.createElement('div');
        prow.className = 'priceRow';
        prow.innerHTML = `
          <div class="peso">$</div>
          <input class="itemPrice" inputmode="decimal" value="${it.price ? fmtARS.format(it.price) : ''}" placeholder="" data-idx="${idx}">
        `;
        right.appendChild(prow);
      });

      // Bind textareas
      left.querySelectorAll('.itemText').forEach(tx=>{
        autoGrow(tx);
        tx.addEventListener('input', (e)=>{
          const i = Number(e.target.dataset.idx);
          items[i].text = e.target.value;
          autoGrow(e.target);
          syncRowHeights();
        });
      });

      // Bind prices
      right.querySelectorAll('.itemPrice').forEach(inp=>{
        inp.addEventListener('blur', (e)=>{
          const i = Number(e.target.dataset.idx);
          const n = parseMoney(e.target.value);
          items[i].price = n;
          e.target.value = n ? fmtARS.format(n) : '';
          recalc();
          syncRowHeights();
        });
      });

      recalc();
      syncRowHeights();
    }

    function addItem(){
      items.push({ text:'', price:0 });
      renderItems();
      // NO hacemos focus automático (como pediste)
    }

    function removeLast(){
      if(items.length <= 1) return;
      items.pop();
      renderItems();
    }

    // ===== Total + pie =====
    function recalc(){
      const total = items.reduce((acc, it)=> acc + (Number(it.price)||0), 0);
      document.getElementById('grandTotal').textContent = fmtARS.format(total);
      renderFooterText(total);
    }

    function renderFooterText(totalOverride){
      const total = (typeof totalOverride === 'number') ? totalOverride
        : items.reduce((acc, it)=> acc + (Number(it.price)||0), 0);

      const cents = Math.round((total - Math.floor(total)) * 100);
      const entero = Math.floor(total);

      const letras = numeroALetras(entero);
      const cc = String(cents).padStart(2,'0');

      document.getElementById('lineMonto').textContent =
        `Son pesos: ${capitalize(letras)} con ${cc}/100`;

      const iva = document.getElementById('chkIva').checked;
      document.getElementById('lineIva').textContent =
        iva ? 'El monto SI contiene IVA' : 'El monto NO contiene IVA';
    }

    function capitalize(s){
      s = (s||'').trim();
      if(!s) return s;
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // Conversión básica a letras (es-AR) para enteros
    function numeroALetras(n){
      if(n === 0) return 'cero';

      const unidades = ['', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve'];
      const especiales = ['diez','once','doce','trece','catorce','quince','dieciséis','diecisiete','dieciocho','diecinueve'];
      const decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
      const centenas = ['', 'ciento', 'doscientos', 'trescientos', 'cuatrocientos', 'quinientos', 'seiscientos', 'setecientos', 'ochocientos', 'novecientos'];

      function menosDeCien(x){
        if(x < 10) return unidades[x];
        if(x < 20) return especiales[x-10];
        if(x < 30){
          if(x === 20) return 'veinte';
          return 'veinti' + unidades[x-20];
        }
        const d = Math.floor(x/10);
        const u = x % 10;
        return u ? `${decenas[d]} y ${unidades[u]}` : decenas[d];
      }

      function menosDeMil(x){
        if(x === 0) return '';
        if(x === 100) return 'cien';
        const c = Math.floor(x/100);
        const r = x % 100;
        const cTxt = c ? centenas[c] : '';
        const rTxt = r ? menosDeCien(r) : '';
        return [cTxt, rTxt].filter(Boolean).join(' ');
      }

      let txt = '';
      let resto = n;

      if(resto >= 1000000000){
        const cnt = Math.floor(resto / 1000000000);
        resto = resto % 1000000000;
        txt += (txt ? ' ' : '') + (cnt === 1 ? 'mil millones' : `${numeroALetras(cnt)} mil millones`);
      }

      if(resto >= 1000000){
        const cnt = Math.floor(resto / 1000000);
        resto = resto % 1000000;
        txt += (txt ? ' ' : '') + (cnt === 1 ? 'un millón' : `${numeroALetras(cnt)} millones`);
      }

      if(resto >= 1000){
        const cnt = Math.floor(resto / 1000);
        resto = resto % 1000;
        txt += (txt ? ' ' : '') + (cnt === 1 ? 'mil' : `${numeroALetras(cnt)} mil`);
      }

      if(resto > 0){
        txt += (txt ? ' ' : '') + menosDeMil(resto);
      }

      txt = txt.replace(/\buno\b/g, 'un');
      return txt.trim();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // ===== Botón Descargar PDF =====
    function descargarPDF(){
      // En desktop abre el diálogo de impresión (Guardar como PDF).
      // En Android normalmente abre el “Guardar como PDF”.
      window.print();
    }

    // ===== Salir =====
    function salir(){
      window.location.href = "ingreso.html";
    }

    // ===== Init =====
    (function init(){
      setToday();
      items = [{ text:'', price:0 }]; // 1 línea inicial
      renderItems();

      // cuando cambia IVA, re-render pie
      document.getElementById('chkIva').addEventListener('change', ()=> renderFooterText());
      window.addEventListener('resize', ()=> syncRowHeights());
    })();
  </script>
</body>
</html>
